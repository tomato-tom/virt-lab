# virt-lab メモ

ここにブレインダンプ、アイディアなどなんでもメモ
まとまったらREADME, docsに書いたり

コンテナ、VM管理スクリプト

~~ 目次 ~~
- 概要
- 2025-07-28
- 2025-08-11
    - rootfsのtarball作成
    - コンテナ作成
    - コンテナ操作
    - TODO
- 雑多なアイディアなど


## 概要

1. コンテナ
    主要ツール
    - systemd-nspawn
    - debootstrap
    ネットワーク
    - iproute2
    - nftables
    - systemd-resolved
    その他
    - tmux
2. VM
    主要ツール
    - kvm-qemu-libvirt
    - cockpit

**付けたい機能**
- 基本操作
    - 作成
    - 削除
    - クローン
    - リスト表示
- デフォルトで簡単に作成できるように
- カスタムネットワーク
- 各種サーバのセットアップ
    - ssh
    - http
    - db
    - router
    - proxy
    - ntp
    - dns
    - dhcp
    - file
    - streaming
    - ...
- テスト開発環境
    - ヘッドレス/GUI
    - Bash
    - Python
    - C/C++
    - Rust/Go


## 2025-07-28

ディレクトリ構成、とりあえず

├── docs
│   ├── memo.md
│   └── note_create_vm.md
├── examples
│   ├── ha-cluster
│   ├── multi-node
│   ├── README.md
│   └── single-node
├── experimental
│   ├── docker_setup.sh
│   ├── incus_docker.sh
│   ├── incus_install.sh
│   ├── incus_uninstall.sh
│   └── lxd_setup.sh
├── kvm
│   ├── clone_vm.sh
│   ├── create_vm.sh
│   ├── delete_vm.sh
│   ├── install_vm.sh
│   └── vm_title.sh
├── lib
│   └── libvirt_domain.py
├── logs
├── nspawn
│   ├── create_container.sh
│   ├── create_rootfs.sh
│   ├── custom.conf
│   └── default.conf
├── README.md
└── setup
    ├── install_kvm_qemu_libvirt.sh
    └── uninstall_kvm.sh


とにかくKVMとnspawnでやって、dockerとかは他でやってVM内にクローンして使うか。
基本的なVMの作成、削除、クローンなどできたら、そのスクリプトを組み合わせてexamples内に単一あるいは複数のVMスクリプトを作成

初期段階でapt-cacher-ng構築しとけば、その後のVM作成時のキャッシュ利用などに使える。
NTP, DNS, DHCPサーバー
PXEブート、prebootでの自動インストール
debootstrapでの自動インストール

典型的なクラスタ、AWSとかのサンプルとかにあるやつ
ホームラボ向けのネットワーク
実験的なの


## 2025-08-11

とりあえずnspawnに集中

今の所
- nspawn
    - create_base_rootfs.sh
    - create_container.sh
    - default.conf
- lib
    - logger.sh
- logs
    - script.log

> この部分のみテスト環境に送ってテスト実行できる
> ホストマシンでやるならコンテナでマウントしてもいいんだが


### rootfsのtarball作成

デフォルト設定ファイルよりdebootstrapで最低限のrootfs作成
`machinectl login`できるようにrootパスワード設定

tarball作成
```
$ ls /srv/nspawn_images/
noble-base-rootfs.tar.gz  stable-base-rootfs.tar.gz
```
> 作成日いれとくか？

### コンテナ作成

tarballよりコンテナ作成
`/var/lib/machines/`に配置

### コンテナ操作

今の所systemd-nspawnかmachinectlで手動操作


### TODO

スクリプトのテストコード
各スクリプトの説明、図解、ドキュメント


## 雑多なアイディアなど
braindump misc

base rootfsはミニマルにして、用途によりスクリプトでセットアップ
コンテナ、VM、あるいはベアメタルに展開
tmpfsに展開して一時的なコンテナとして
ネストしたコンテナ、３層くらいまで

ドキュメントの作成、あとで自分でわかるように
- AIでざっと書く
- 動作確認して編集
- nspawnコンテナの基本操作
- コンテナネットワーク
    - bridge, veth
    - routing, firewall
        - iproute2
        - nftables

ログ、テストなども
コードの規則性、りんたー
変数、関数の命名規則

VM(KVM/QEMU)とコンテナ(nspawn)でプロジェクト分ける？
共通セットアップも多いと思う

使ってみたい技術
keepalived VM、コンテナの高可用性
PXEboot 自動インストール
overlayfs  変更しないbase-rootfsを複数コンテナで共有して、上部を書くコンテナで変更

