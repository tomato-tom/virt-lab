# virt-lab メモ

ここにブレインダンプ、アイディアなどなんでもメモ
まとまったらREADME, docsに書いたり

コンテナ、VM管理スクリプト

~~ 目次 ~~
- 概要
- 2025-07-28
- 2025-08-11
    - rootfsのtarball作成
    - コンテナ作成
    - コンテナ操作
    - TODO
- 雑多なアイディアなど


## 概要

1. コンテナ
    主要ツール
    - systemd-nspawn
    - debootstrap
    ネットワーク
    - iproute2
    - nftables
    - systemd-resolved
    その他
    - tmux
2. VM
    主要ツール
    - kvm-qemu-libvirt
    - cockpit

**付けたい機能**
- 基本操作
    - 作成
    - 削除
    - クローン
    - リスト表示
- デフォルトで簡単に作成できるように
- カスタムネットワーク
- 各種サーバのセットアップ
    - ssh
    - http
    - db
    - router
    - proxy
    - ntp
    - dns
    - dhcp
    - file
    - streaming
    - ...
- テスト開発環境
    - ヘッドレス/GUI
    - Bash
    - Python
    - C/C++
    - Rust/Go


## 2025-07-28

ディレクトリ構成、とりあえず

```
├── docs
│   ├── memo.md
│   └── note_create_vm.md
├── examples
│   ├── ha-cluster
│   ├── multi-node
│   ├── README.md
│   └── single-node
├── experimental
│   ├── docker_setup.sh
│   ├── incus_docker.sh
│   ├── incus_install.sh
│   ├── incus_uninstall.sh
│   └── lxd_setup.sh
├── kvm
│   ├── clone_vm.sh
│   ├── create_vm.sh
│   ├── delete_vm.sh
│   ├── install_vm.sh
│   └── vm_title.sh
├── lib
│   └── libvirt_domain.py
├── logs
├── nspawn
│   ├── create_container.sh
│   ├── create_rootfs.sh
│   ├── custom.conf
│   └── default.conf
├── README.md
└── setup
    ├── install_kvm_qemu_libvirt.sh
    └── uninstall_kvm.sh
```


とにかくKVMとnspawnでやって、dockerとかは他でやってVM内にクローンして使うか。
基本的なVMの作成、削除、クローンなどできたら、そのスクリプトを組み合わせてexamples内に単一あるいは複数のVMスクリプトを作成

初期段階でapt-cacher-ng構築しとけば、その後のVM作成時のキャッシュ利用などに使える。
NTP, DNS, DHCPサーバー
PXEブート、prebootでの自動インストール
debootstrapでの自動インストール

典型的なクラスタ、AWSとかのサンプルとかにあるやつ
ホームラボ向けのネットワーク
実験的なの


## 2025-08-11

とりあえずnspawnに集中

今の所
- nspawn
    - create_base_rootfs.sh
    - create_container.sh
    - default.conf
- lib
    - logger.sh
- logs
    - script.log

> この部分のみテスト環境に送ってテスト実行できる
> ホストマシンでやるならコンテナでマウントしてもいいんだが


## 2025-08-22

引き続きnspawnのスクリプト

```
├── docs
│   ├── getting-started-nspawn.md   # このへんのはAI生成そのまま
│   ├── index.md
│   ├── nspawn-basic.md
│   └── nspawn-markmap.md
├── examples
│   ├── ha-cluster
│   ├── multi-node
│   ├── README.md
│   └── single-node
├── kvm
│   ├── clone_vm.sh
│   ├── create_vm.sh
│   ├── delete_vm.sh
│   ├── install_vm.sh
│   └── vm_title.sh
├── lib
│   └── logger.sh
├── logs
│   ├── script.log
│   ├── script.log.1
│   ├── script.log.2
│   └── script.log.3
├── misc
│   ├── archlinux_install.sh
│   ├── docker_setup.sh
│   ├── incus_docker.sh
│   ├── incus_install.sh
│   ├── incus_uninstall.sh
│   ├── lxd_setup.sh
│   ├── nodejs-setup.sh
│   ├── pars_ini.sh
│   └── run_container.sh
├── nspawn
│   ├── create_base_rootfs.sh          # だいたいできた
│   ├── create_container.sh            # だいたいできた
│   ├── run_container.sh               # だいたいできた
│   ├── stop_container.sh              # だいたいできた
│   ├── remove_container.sh
│   ├── list_container.sh
│   ├── debian_static_address.sh
│   ├── default.conf
│   ├── custom.conf
│   ├── README.md
│   └── setup_nspawn.sh 
├── README.md
├── setup
│   ├── install_kvm_qemu_libvirt.sh
│   └── uninstall_kvm.sh
└── tests
    └── logger_test.sh

13 directories, 39 files
```

## 機能
### rootfsのtarball作成

デフォルト設定ファイルよりdebootstrapで最低限のrootfs作成
`machinectl login`できるようにrootパスワード設定

tarball作成
```
$ ls /srv/nspawn_images/
noble-base-rootfs.tar.gz  stable-base-rootfs.tar.gz
```
> 作成日いれとくか？
> 2025-08-22-stable-base-rootfs.tar.gz

### コンテナ作成

tarballよりコンテナ作成
デフォルトの`/var/lib/machines/`に配置

### コンテナ操作

今の所systemd-nspawnかmachinectlで手動操作
`run_container.sh`     # コンテナ起動
`stop_container.sh`    # 停止


## 主要なネットワークオプション
`systemd-nspawn` のネットワーク関連オプションについて
> https://www.freedesktop.org/software/systemd/man/devel/systemd-nspawn.html

`--private-network`
- コンテナのネットワークをホストから切断
- ループバックデバイスと明示的に指定されたインターフェース以外は利用不可
- このオプションを指定すると `CAP_NET_ADMIN` 権限が付与される

`--network-interface=`
- 指定したネットワークインターフェースをコンテナに割り当て
- `ホスト側名:コンテナ側名` の形式で指定可能
- `--private-network` を暗黙的に含む

> NICパススルー？

`--network-macvlan=`, `--network-ipvlan=`
- 物理インターフェースから仮想インターフェースを作成してコンテナに追加
- macvlanは別MACアドレス、ipvlanは同じMACアドレスを使用
- `--private-network` を暗黙的に含む

`-n, --network-veth`
- ホストとコンテナ間に仮想Ethernetリンク（veth）を作成
- デフォルトでDHCPによる自動アドレス割り当てが設定される
- `--private-network` を暗黙的に含む
- `systemd-nspawn@.service` 使用時のデフォルト

`--network-bridge=`
- `--network-veth` で作成したホスト側インターフェースを指定したブリッジに追加
- `--network-veth` を暗黙的に含む

`--network-zone=`
- 自動管理されるEthernetブリッジにコンテナを接続
- 複数コンテナを同じ仮想ネットワークゾーンに参加させられる
- ブリッジは自動的に作成/削除される

> ホスト、コンテナ共にsystemd-networkd動いてる前提なら、これが簡単にNAT外部アクセスできる
> systemd-nspawn -bM ct1 --network-zone=br-zone0
> ホストマシンに`br-zone0が作成されて、そのブリッジにNAT,コンテナ内のIPアドレス設定が自動作成される
> 追加のネットワークも簡単にできる

`--network-namespace-path=`
- 既存のネットワーク名前空間をコンテナで使用
- 他のネットワークオプションと併用不可

> これを主に使うか、ライブ変更に向いてそう

`-p, --port=`
- プライベートネットワーク使用時、ホストのポートをコンテナのポートにマッピング
- 形式: `[プロトコル:]ホストポート[:コンテナポート]`

> 重要な注意点
- 多くのオプションでは、基盤となるネットワークインターフェースがコンテナ起動時に既に存在している必要がある
- 起動時の依存関係を確実にするため、systemd unitファイルでの明示的な設定が推奨される
- ネットワークインターフェース名は15文字以内に制限されるため、コンテナ名の長さに注意が必要

これらのオプションを組み合わせることで、コンテナのネットワーク分離レベルや接続方法を柔軟に制御できます。


## ネットワーク設定スクリプト

`con net create br0`
`./network attach ct1 br0`
のように？

ip [link addr route]
nft

netplanを使うか、yaml形式まねしてyqでやるか。。。
go-yqが便利そう
systemd-networkdの設定ファイルを単に渡して、細かい部分はipでやるか

その前にネットワークつながらない？


### TODO

スクリプトのテストコード
各スクリプトの説明、図解、ドキュメント


## 雑多なアイディアなど
braindump misc

base rootfsはミニマルにして、用途によりスクリプトでセットアップ
コンテナ、VM、あるいはベアメタルに展開
tmpfsに展開して一時的なコンテナとして
ネストしたコンテナ、３層くらいまで

ドキュメントの作成、あとで自分でわかるように
- AIでざっと書く
- 動作確認して編集
- nspawnコンテナの基本操作
- コンテナネットワーク
    - bridge, veth
    - routing, firewall
        - iproute2
        - nftables

ログ、テストなども
コードの規則性、りんたー
変数、関数の命名規則
web UI

VM(KVM/QEMU)とコンテナ(nspawn)でプロジェクト分ける
netns操作の部分はnetns-labの方でいいか、ブリッジとかも
- virt-lab KVM/QEMU/libvirt
- netns-lab netns,bridge
- nspawn-script nspawn

使ってみたい技術
keepalived VM、コンテナの高可用性
PXEboot 自動インストール
overlayfs  変更しないbase-rootfsを複数コンテナで共有して、上部を書くコンテナで変更

